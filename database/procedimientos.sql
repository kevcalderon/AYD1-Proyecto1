DELIMITER $$
CREATE PROCEDURE CrearDireccion(
    IN MUNICIPIO_ID BIGINT,
    IN LUGAR VARCHAR(500),
    OUT DIR_ID BIGINT
)
BEGIN
    INSERT INTO DIRECCION (MUNICIPIO_MUN_ID, LUGAR) VALUES (MUNICIPIO_ID, LUGAR);
    SET DIR_ID = LAST_INSERT_ID();
END $$
DELIMITER ;

DELIMITER $$
CREATE PROCEDURE ActualizarEstadoOrden(
    IN ID_ORDEN BIGINT
)
BEGIN
	DECLARE cantidad_rechazado INT;
	DECLARE cantidad_aceptado INT;
	DECLARE cantidad_pendiente INT;
	SET cantidad_rechazado = (SELECT COUNT(do.ORDEN_ORD_ID) FROM DETALLE_ORDEN do  WHERE do.ORDEN_ORD_ID = ID_ORDEN AND do.ESTADO = 'RECHAZADO' GROUP BY do.ORDEN_ORD_ID);
	IF cantidad_rechazado > 0 THEN
		UPDATE ORDEN SET ESTADO = 'CANCELADO' WHERE ORD_ID = ID_ORDEN;
	ELSE
		SET cantidad_pendiente = (SELECT COUNT(ORDEN_ORD_ID) FROM DETALLE_ORDEN do WHERE ESTADO = 'PENDIENTE');
		IF cantidad_pendiente = 0 THEN
			UPDATE ORDEN SET ESTADO = 'RECIBIDO' WHERE ORD_ID = ID_ORDEN;			
		END IF;
	END IF;
END $$
DELIMITER ;

DELIMITER $$
CREATE PROCEDURE AsignarPedidoRepartidor(
    IN ID_ORDEN BIGINT,
    IN USUARIO VARCHAR(250)
)
BEGIN
    IF (SELECT COUNT(O.ESTADO) FROM ORDEN O WHERE O.ESTADO = 'EN PROCESO' AND O.REPARTIDOR_REP_ID = USUARIO) = 0 THEN
        UPDATE ORDEN O
        INNER JOIN REPARTIDOR R on O.REPARTIDOR_REP_ID = R.REP_ID
        SET O.ESTADO = 'EN PROCESO'
        WHERE O.ESTADO = 'RECIBIDO' AND O.ORD_ID=ID_ORDEN AND R.USUARIO = USUARIO;
    END IF;
END $$
DELIMITER ;

DELIMITER $$
CREATE PROCEDURE AceptarSolicitud(
    IN ID_SOLICITUD BIGINT,
    OUT SALIDA VARCHAR(500)
)
BEGIN
    DECLARE TIPO_SOL VARCHAR(100);
    DECLARE ID_EMPRESA BIGINT;
    DECLARE ID_REPARTIDOR BIGINT;
    DECLARE ID_DIRECCION BIGINT;
    SET TIPO_SOL = (SELECT TIPO_SOLICITUD FROM SOLICITUD WHERE SOL_ID = ID_SOLICITUD);
    SET ID_EMPRESA = (SELECT EMPRESA_EMP_ID FROM SOLICITUD WHERE SOL_ID = ID_SOLICITUD);
    SET ID_REPARTIDOR = (SELECT REPARTIDOR_REP_ID FROM SOLICITUD WHERE SOL_ID = ID_SOLICITUD);
    IF ID_EMPRESA IS NOT NULL THEN
        CASE TIPO_SOL
            WHEN 'REGISTRO' THEN
                UPDATE EMPRESA SET ESTADO = 'ACEPTADO' WHERE EMP_ID = ID_EMPRESA;
                UPDATE SOLICITUD SET ESTADO = 'ACEPTADO' WHERE SOL_ID = ID_SOLICITUD;
                SET SALIDA = 'SE HA ACEPTADO LA SOLICITUD DE REGISTRO DE LA EMPRESA';
        END CASE ;
    ELSEIF  ID_REPARTIDOR IS NOT NULL THEN
        CASE TIPO_SOL
            WHEN 'REGISTRO' THEN
                UPDATE REPARTIDOR SET ESTADO = 'ACEPTADO' WHERE REP_ID = ID_REPARTIDOR;
                UPDATE SOLICITUD SET ESTADO = 'ACEPTADO' WHERE SOL_ID = ID_SOLICITUD;
                SET SALIDA = 'SE HA ACEPTADO LA SOLICITUD DE REGISTRO DEL REPARTIDOR';
            WHEN 'ACTUALIZACION' THEN
               SET ID_DIRECCION = (SELECT DIRECCION_DIR_ID  FROM SOLICITUD WHERE SOL_ID= ID_SOLICITUD);
               IF ID_DIRECCION IS NOT NULL THEN
                   UPDATE REPARTIDOR SET DIRECCION_DIR_ID = ID_DIRECCION WHERE REP_ID = ID_REPARTIDOR;
                   UPDATE SOLICITUD SET ESTADO = 'ACEPTADO' WHERE SOL_ID = ID_SOLICITUD;
                   SET SALIDA = 'SE HA APROBADO LA SOLICITUD DE CAMBIO DE DIRECCION DEL REPARTIDOR';
                ELSE
                   SET SALIDA = 'NO HA INGRESADO LA DIRECCION NUEVA EN LA SOLICITUD';
               END IF;
        END CASE ;
    ELSE
        SET SALIDA = 'NO SE HA PODIDO APROBAR LA SOLICITUD';
    END IF;
END $$
DELIMITER ;

DELIMITER $$
CREATE PROCEDURE RechazarSolicitud(
    IN ID_SOLICITUD BIGINT,
    OUT SALIDA VARCHAR(500)
)
BEGIN
    DECLARE TIPO_SOL VARCHAR(100);
    DECLARE ID_EMPRESA BIGINT;
    DECLARE ID_REPARTIDOR BIGINT;
    DECLARE ID_DIRECCION BIGINT;
    SET TIPO_SOL = (SELECT TIPO_SOLICITUD FROM SOLICITUD WHERE SOL_ID = ID_SOLICITUD);
    SET ID_EMPRESA = (SELECT EMPRESA_EMP_ID FROM SOLICITUD WHERE SOL_ID = ID_SOLICITUD);
    SET ID_REPARTIDOR = (SELECT REPARTIDOR_REP_ID FROM SOLICITUD WHERE SOL_ID = ID_SOLICITUD);
    IF ID_EMPRESA IS NOT NULL THEN
        CASE TIPO_SOL
            WHEN 'REGISTRO' THEN
                UPDATE EMPRESA SET ESTADO = 'RECHAZADO' WHERE EMP_ID = ID_EMPRESA;
                UPDATE SOLICITUD SET ESTADO = 'RECHAZADO' WHERE SOL_ID = ID_SOLICITUD;
                SET SALIDA = 'SE HA RECHAZADO LA SOLICITUD DE REGISTRO DE LA EMPRESA';
        END CASE ;
    ELSEIF  ID_REPARTIDOR IS NOT NULL THEN
        CASE TIPO_SOL
            WHEN 'REGISTRO' THEN
                UPDATE REPARTIDOR SET ESTADO = 'RECHAZADO' WHERE REP_ID = ID_REPARTIDOR;
                UPDATE SOLICITUD SET ESTADO = 'RECHAZADO' WHERE SOL_ID = ID_SOLICITUD;
                SET SALIDA = 'SE HA RECHAZADO LA SOLICITUD DE REGISTRO DEL REPARTIDOR';
            WHEN 'ACTUALIZACION' THEN
               SET ID_DIRECCION = (SELECT DIRECCION_DIR_ID  FROM SOLICITUD WHERE SOL_ID= ID_SOLICITUD);
               IF ID_DIRECCION IS NOT NULL THEN
                   UPDATE SOLICITUD SET ESTADO = 'RECHAZADO' WHERE SOL_ID = ID_SOLICITUD;
                   SET SALIDA = 'SE HA RECHAZADO LA SOLICITUD DE CAMBIO DE DIRECCION DEL REPARTIDOR';
                ELSE
                   SET SALIDA = 'NO HA INGRESADO LA DIRECCION NUEVA EN LA SOLICITUD';
               END IF;
        END CASE ;
    ELSE
        SET SALIDA = 'NO SE HA PODIDO RECHAZAR LA SOLICITUD';
    END IF;
END $$
DELIMITER ;